// Jesse's code ***********************
$(document).on("ready", function() {
  $(".datepicker").datepicker();
});



// Maps *******************************
var coordinates = [];
var travelPoints = [];// Will hold google processed coordinates data
var keyPhotos = [];
var map;
var bounds;
var markers = [];

// Raw coordinates from trip data
for (var i = 0; i < gon.locations.length; i++){
  coordinates.push([gon.locations[i].lat, gon.locations[i].lng]);
}
// Thumbnails from trip data
for (var i = 0; i < gon.locations.length; i++){
  keyPhotos.push(gon.locations[i].thumbnail);
}


function initialize(){
  var mapOptions = {
    // Skin
    mapTypeId: google.maps.MapTypeId.TERRAIN,
    styles: [{"featureType":"landscape",
              "stylers":[{"lightness":5},{"hue":"#ff001a"},{"saturation":-51}]},
              {"featureType":"road.highway","stylers":[{"hue":"#ff0011"},{"lightness":53}]},
              {"featureType":"poi.park","stylers":[{"hue":"#00ff91"}]},
              {"elementType":"labels","stylers":[{"lightness":63},{"hue":"#ff0000"}]},
              {"featureType":"road","elementType":"labels","stylers":[{"visibility":"off"}]}
              ]
  };
  map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);
  bounds = new google.maps.LatLngBounds();
  mapPoints();// Process coordinates
  autoMarkers();// Draw markers
  // map.fitBounds(bounds); // set center and zoom level

  // SEARCH
  // Create the search box and link it to the UI element.
  var input = document.getElementById('search-maps');
  map.controls[google.maps.ControlPosition.TOP].push(input);
  var searchBox = new google.maps.places.SearchBox(input);

  // Listen for search event
  google.maps.event.addListener(searchBox, 'places_changed', function(){
    var places = searchBox.getPlaces();
    var place = places[0];
    travelPoints.push(place.geometry.location);
    // Clear all marker data
    clearMarkers();
    // Update Marker draw
    autoMarkers();
    map.fitBounds(bounds);
  });
}

// convert coordinates into google.map objects
var mapPoints = function(){
  for (var i = 0; i < coordinates.length; i++){
    travelPoints.push(new google.maps.LatLng(coordinates[i][0], coordinates[i][1]));
  }
};

function clearMarkers(){
  for (var i = 0; i < markers.length; i++){
    markers[i].setMap(null);
  }
  markers = [];
}

// Draw markers with delay animation
function autoMarkers(){
  var loop = function(arr, index, callback) {
    var done = function(){
      if (index < arr.length){
        loop(arr, index + 1, callback);
      }
    };
    callback(arr, index, done);
  };

  loop(travelPoints, 0, function(travelPoints, i, done){
    markerImage = new google.maps.MarkerImage("<%= asset_path('balloonMarker.png') %>");
    markerImage.anchor = new google.maps.Point(20, 53);

    setTimeout(function(){
      markers.push(new google.maps.Marker({
        position: travelPoints[i],
        map: map,
        draggable: false,
        animation: google.maps.Animation.DROP,
        icon: markerImage
      }));
      if( i > 0) {
        var line = new google.maps.Polyline({
          geodesic: true,
          path: [travelPoints[i-1], travelPoints[i]],
          strokeColor:"orange",
          strokeOpacity:0.9,
          strokeWeight:2,
          map: map
        });
      }
      markers[i].setTitle(i.toString());
      // keyPhotos.push(addPhoto);

      markerInfo(markers[i], i);
      bounds.extend(travelPoints[i]);
      if (i > 0){
        map.fitBounds(bounds);
      }
      done();
    }, 200);
  });
}

function markerInfo(marker, i) {
  var infoWindow = new google.maps.InfoWindow({
    content: "...no picture"
  });
  var content = "<img src='" + keyPhotos[i] + "'>";
  infoWindow.setContent(content);
  google.maps.event.addListener(marker, 'click', function() {
  infoWindow.open(marker.get('map'), marker);
  });
}

// Creates javascript tags and calls initialize function
function loadScript() {
  var GOOGLE_KEY = "<%= Rails.application.secrets.google_key %>";
  console.log(GOOGLE_KEY)
  var script = document.createElement('script');
  script.src = 'https://maps.googleapis.com/maps/api/js?key=' + GOOGLE_KEY + '&sensor=true&libraries=places&callback=initialize';
  document.body.appendChild(script);
}

window.onload = loadScript;
// google.maps.event.addDomListener(window, 'load', loadScript);



// from trips_controller
// @medias[0].lat = latitude
// @medias[0].lng = longitude
// @medias[0].thumbnail = small pic
// @medias[0].full_res_img = large pic
// @medias[0].date_taken = date picture was taken






